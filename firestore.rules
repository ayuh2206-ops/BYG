rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ═══════════════════════════════════════════════
    // Helper Functions
    // ═══════════════════════════════════════════════
    
    // Check if user is authenticated (any method including anonymous)
    function isAuth() {
      return request.auth != null;
    }
    
    // Check if user is a real (non-anonymous) authenticated user
    function isRealUser() {
      return request.auth != null && request.auth.token.firebase.sign_in_provider != 'anonymous';
    }
    
    // Check if user owns this document
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    // Check if user has a specific role
    function hasRole(role) {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny([role]);
    }

    // ═══════════════════════════════════════════════
    // 1. USERS Collection
    // ═══════════════════════════════════════════════
    match /users/{userId} {
      // Anyone authenticated can read any user profile (needed for discovery)
      allow read: if isAuth();
      
      // Users can create their own document
      allow create: if isOwner(userId);
      
      // Users can update their own document
      allow update: if isOwner(userId);
      
      // Users can delete their own document
      allow delete: if isOwner(userId);
      
      // Analytics subcollection (private to user)
      match /analytics/{docId} {
        allow read, write: if isOwner(userId);
      }
      
      // Any nested subcollection under user
      match /{subcollection}/{docId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ═══════════════════════════════════════════════
    // 2. PROFILES Collection (Guide/Agency public profiles)
    // ═══════════════════════════════════════════════
    match /profiles/{profileId} {
      // Anyone can read profiles (needed for discovery/search)
      allow read: if isAuth();
      
      // Profile owner can create/update/delete
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // ═══════════════════════════════════════════════
    // 3. TRIPS Collection
    // ═══════════════════════════════════════════════
    match /trips/{tripId} {
      // Trip owner, assigned guide, or assigned agency can read
      allow read: if isAuth() && (
        resource.data.userId == request.auth.uid ||
        resource.data.guideId == request.auth.uid ||
        resource.data.agencyId == request.auth.uid ||
        request.auth.uid in resource.data.groupMembers
      );
      
      // Any authenticated user can create a trip
      allow create: if isAuth();
      
      // Trip owner, guide, or agency can update
      allow update: if isAuth() && (
        resource.data.userId == request.auth.uid ||
        resource.data.guideId == request.auth.uid ||
        resource.data.agencyId == request.auth.uid
      );
      
      // Trip owner can delete
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
      
      // Votes subcollection (group voting - The Gavel)
      match /votes/{voteId} {
        allow read: if isAuth();
        allow create: if isAuth();
        allow update: if isAuth();
      }
      
      // Alerts subcollection (self-healing weather alerts)
      match /alerts/{alertId} {
        allow read: if isAuth();
        allow create, update: if isAuth();
      }
    }

    // ═══════════════════════════════════════════════
    // 4. ITINERARIES Collection
    // ═══════════════════════════════════════════════
    match /itineraries/{itineraryId} {
      // Anyone involved in the trip can read
      allow read: if isAuth();
      
      // Any authenticated user can create
      allow create: if isAuth();
      
      // Any authenticated user can update (collaborative editing)
      allow update: if isAuth();
      
      // Creator can delete
      allow delete: if isAuth();
      
      // Activities subcollection
      match /activities/{activityId} {
        allow read: if isAuth();
        allow create, update, delete: if isAuth();
      }
    }

    // ═══════════════════════════════════════════════
    // 5. QUOTES Collection
    // ═══════════════════════════════════════════════
    match /quotes/{quoteId} {
      // Traveler or provider can read their quotes
      allow read: if isAuth() && (
        resource.data.travelerId == request.auth.uid ||
        resource.data.providerId == request.auth.uid
      );
      
      // Any authenticated user can create a quote request
      allow create: if isAuth();
      
      // Either party can update (negotiation)
      allow update: if isAuth() && (
        resource.data.travelerId == request.auth.uid ||
        resource.data.providerId == request.auth.uid
      );
      
      // Either party can delete/cancel
      allow delete: if isAuth() && (
        resource.data.travelerId == request.auth.uid ||
        resource.data.providerId == request.auth.uid
      );
    }

    // ═══════════════════════════════════════════════
    // 6. BOOKINGS Collection
    // ═══════════════════════════════════════════════
    match /bookings/{bookingId} {
      // Traveler or provider can read
      allow read: if isAuth() && (
        resource.data.travelerId == request.auth.uid ||
        resource.data.providerId == request.auth.uid
      );
      
      // Any authenticated user can create
      allow create: if isAuth();
      
      // Either party can update
      allow update: if isAuth() && (
        resource.data.travelerId == request.auth.uid ||
        resource.data.providerId == request.auth.uid
      );
      
      // Owner can delete
      allow delete: if isAuth();
    }

    // ═══════════════════════════════════════════════
    // 7. TOURS Collection (Agency tour packages)
    // ═══════════════════════════════════════════════
    match /tours/{tourId} {
      // Anyone authenticated can read tours (marketplace discovery)
      allow read: if isAuth();
      
      // Any authenticated user can create (agencies)
      allow create: if isAuth();
      
      // Tour creator can update
      allow update: if isAuth() && resource.data.agencyId == request.auth.uid;
      
      // Tour creator can delete
      allow delete: if isAuth() && resource.data.agencyId == request.auth.uid;
    }

    // ═══════════════════════════════════════════════
    // 8. MESSAGES Collection
    // ═══════════════════════════════════════════════
    match /messages/{messageId} {
      // Sender or recipient can read
      allow read: if isAuth() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.recipientId == request.auth.uid
      );
      
      // Any authenticated user can send messages
      allow create: if isAuth();
      
      // Recipient can update (mark as read)
      allow update: if isAuth() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.recipientId == request.auth.uid
      );
    }

    // ═══════════════════════════════════════════════
    // 9. NOTIFICATIONS Collection
    // ═══════════════════════════════════════════════
    match /notifications/{notificationId} {
      // User can read their own notifications
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      
      // System/any user can create notifications
      allow create: if isAuth();
      
      // User can update own (mark as read)
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      
      // User can delete own
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }

    // ═══════════════════════════════════════════════
    // 10. REVIEWS Collection
    // ═══════════════════════════════════════════════
    match /reviews/{reviewId} {
      // Anyone can read reviews (public)
      allow read: if isAuth();
      
      // Authenticated users can create reviews
      allow create: if isAuth();
      
      // Review author can update
      allow update: if isAuth() && resource.data.travelerId == request.auth.uid;
      
      // Review author can delete
      allow delete: if isAuth() && resource.data.travelerId == request.auth.uid;
    }

    // ═══════════════════════════════════════════════
    // 11. ARTIFACTS Collection (Legacy from existing app)
    // ═══════════════════════════════════════════════
    match /artifacts/{appId} {
      allow read, write: if isAuth();
      
      match /{document=**} {
        allow read, write: if isAuth();
      }
    }

    // ═══════════════════════════════════════════════
    // CATCH-ALL: Any other collection
    // For Phase 1 beta, allow authenticated users
    // to read/write anything. Tighten in Phase 2.
    // ═══════════════════════════════════════════════
    match /{collection}/{document=**} {
      allow read, write: if isAuth();
    }
  }
}
